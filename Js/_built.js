function CaseEffectController(client){this.client=client}function ClientController(view,DOMView,helper){this.socket={},this.view=view,this.DOMView=DOMView,this.Helper=helper,this.resources={chooseDirection:"Choisissez le sens dans lequel contrôller la rangée."}}function CoordsProvider(){}function DOMView(helper){this.caseWidth=175,this.caseHeight=175,this.resources={waiting:"En attente des autres joueurs...",go:"C'est parti !",guardiansWins:"La partie est finie, les gardiens ont gagné !"},this.Helper=helper}function ErrorView(helper){this.Helper=helper,this.divError=$("#error-view"),this.resources={errorLogin:"Requis, lettre uniquement. ' et - autorisés."}}function HelperController(){}function MainView(helper,DOMView,CoordsProvider){this.caseWidth=175,this.caseHeight=175,this.Helper=helper,this.CaseEffect=null,this.DOMView=DOMView,this.CoordsProvider=CoordsProvider,this.resources={alreadyAGame:"Il y a actuellement déjà une partie qui se joue entre ",waitForEnd:". Veillez patienter jusqu'à la fin de celle-ci.",and:" et ",thePlayerIsDead:"Le joueur {0} est mort !",itRestTours:"Il reste {0} tours !",turnOf:"Tour de ",chooseWhatToSee:"Choisissez la case que vous souhaitez regarder.",chooseWhatToControl:"Choisissez la rangée que vous souhaitez contrôller.",chooseWhereToGo:"Choisissez la case où vous voulez vous rendre.",chooseExchange:"Choisissez la case à échanger."},this.Rtc=new RtcController}function manageTurn(u,users,helper,cProvider){var coords=[];if(""!==u.action1)if("Déplacer"===u.action1)coords=cProvider.getCoordsDeplacerRegarder(u),appendSelect(coords,u.action1,helper);else if("Pousser"===u.action1){for(var a in users)users.hasOwnProperty(a)&&users[a].id!==u.id&&users[a].position.x===u.position.x&&users[a].position.y===u.position.y&&coords.push(users[a]);appendCharacterSelectMe(coords,u.action1,helper)}else"Regarder"===u.action1?(coords=cProvider.getCoordsDeplacerRegarder(u),appendSelect(coords,u.action1,helper)):"Contrôller"===u.action1&&(coords=cProvider.getCoordsController(u),appendSelect(coords,u.action1,helper));else if("Déplacer"===u.action2)coords=cProvider.getCoordsDeplacerRegarder(u),appendSelect(coords,u.action2,helper);else if("Pousser"===u.action2){for(var b in users)users.hasOwnProperty(b)&&users[b].id!==u.id&&users[b].position.x===u.position.x&&users[b].position.y===u.position.y&&coords.push(users[b]);appendCharacterSelectMe(coords,u.action2,helper)}else"Regarder"===u.action2?(coords=cProvider.getCoordsDeplacerRegarder(u),appendSelect(coords,u.action2,helper)):"Contrôller"===u.action2&&(coords=cProvider.getCoordsController(u),appendSelect(coords,u.action2,helper))}function manageComplexAction(object,helper,cProvider){"Pousser"===object.action?(coords=cProvider.getCoordsDeplacerRegarder(object.user),appendSelect(coords,object.action,helper)):"Contrôller"===object.action&&$(".tourDe").append($(".selectMe").length>8?'<p class="sensArrows" data-position='+object.coords+'><span class="right direction">&rarr;</span><span class="left direction">&larr;</span><span class="top direction">&uarr;</span><span class="bottom direction">&darr;</span></p>':object.coords.split("-")[0].parseInt()>object.user.position.x||object.coords.split("-")[0].parseInt()<object.user.position.x?'<p class="sensArrows" data-position='+object.coords+'><span class="right direction">&rarr;</span><span class="left direction">&larr;</span></p>':'<p class="sensArrows" data-position='+object.coords+'><span class="top direction">&uarr;</span><span class="bottom direction">&darr;</span></p>')}function appendSelect(coords,action,helper){for(var c in coords)coords.hasOwnProperty(c)&&(helper.GetTuile(coords[c].x,coords[c].y).append('<div class="selectMe" data-action="'+action+'"></div>'),$(".selectMe").animate({width:"175px",height:"175px"},500))}function appendCharacterSelectMe(coords,action,helper){for(var c in coords)coords.hasOwnProperty(c)&&helper.GetCharacterDiv(coords[c].id).append('<div class="characterSelectMe" data-action="'+action+'"></div>')}function RtcController(){this.startButton=document.getElementById("startButton"),this.callButton=document.getElementById("callButton"),this.hangupButton=document.getElementById("hangupButton"),this.videoLocal=null,this.videosRemote=[],this.pcLocal=null,this.pcRemote=[],this.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},this.Adapter=new RtcAdapterController}function RtcAdapterController(){this.getUserMedia=null,this.attachMediaStream=null,this.reattachMediaStream=null,this.webrtcDetectedBrowser=null,this.webrtcDetectedVersion=null,this.webrtcMinimumVersion=null}Array.prototype.lastIndexOf=function(o){for(var index=this.length;index>=0;index--)if(index in this&&this[index]===o)return index;return-1},Array.prototype.insertAt=function(o,index){return index>-1&&index<=this.length?(this.splice(index,0,o),!0):!1},Array.prototype.insertBefore=function(o,toInsert){var index=this.indexOf(o);return-1==index?!1:0===index?(this.unshift(toInsert),!0):this.insertAt(toInsert,index-1)},Array.prototype.insertAfter=function(o,toInsert){var index=this.indexOf(o);return-1==index?!1:index==this.length-1?(this.push(toInsert),!0):this.insertAt(toInsert,index+1)},Array.prototype.remove=function(from,to){var rest=this.slice((to||from)+1||this.length);return this.length=0>from?this.length+from:from,this.push.apply(this,rest)},Array.prototype.first=function(attribut,value){for(var i=0;i<this.length;i++)if(this[i][attribut]==value)return this.slice(i,i+1)[0];return null},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.where=function(attribut,value){for(var res=[],i=0;i<this.length;i++)this[i][attribut]==value&&res.push(this.slice(i,i+1));return res},String.prototype.replaceAll=function(replace,value){return this.replace(new RegExp(replace,"g"),value)},String.prototype.parseInt=function(){return 1*this};var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=Base64._utf8_encode(input);i<input.length;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4);return output},decode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)enc1=this._keyStr.indexOf(input.charAt(i++)),enc2=this._keyStr.indexOf(input.charAt(i++)),enc3=this._keyStr.indexOf(input.charAt(i++)),enc4=this._keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3));return output=Base64._utf8_decode(output)},_utf8_encode:function(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext},_utf8_decode:function(utftext){for(var string="",i=0,c=0,c2=0;i<utftext.length;)c=utftext.charCodeAt(i),128>c?(string+=String.fromCharCode(c),i++):c>191&&224>c?(c2=utftext.charCodeAt(i+1),string+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=utftext.charCodeAt(i+1),c3=utftext.charCodeAt(i+2),string+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return string}};CaseEffectController.prototype.manageCaseEffect=function(user,effect,userMain){var nextOne=userMain?userMain:user;if("death"===effect)this.client.emitDeath(user),setTimeout(this.client.emitNextPlayer,200,nextOne);else if("noSee"===effect){var userDiv=this.client.view.Helper.GetCharacterDiv(user.id);userDiv.attr("handicap","noSee"),this.client.emitNextPlayer(nextOne)}else if("noSecondAction"===effect){var userDiv1=this.client.view.Helper.GetCharacterDiv(user.id);userDiv1.attr("handicap","noSecondAction"),this.client.emitNextPlayer(nextOne)}else if("deathAfterNextAction"===effect){var userDiv2=this.client.view.Helper.GetCharacterDiv(user.id);userDiv2.attr("handicap","deathAfterNextAction"),this.client.emitNextPlayer(nextOne)}else if("deathAfterNextTour"===effect){var userDiv3=this.client.view.Helper.GetCharacterDiv(user.id);userDiv3.attr("handicap","deathAfterNextTour"),this.client.emitNextPlayer(nextOne)}else"exchangeTuile"===effect?this.client.view.exchangeAndApplyTuile(user.id):"deathIfTwo"===effect?this.client.emitDeathForFirstHere(user):"doController"===effect?this.client.view.controller(user):"goTo2-2"===effect?this.client.emitGoToCentral(user):"doSee"===effect?(this.client.view.regarder(user.id),this.client.emitNextPlayer(nextOne)):"goInAnotherTuile"===effect?this.client.view.exchangeTuile(user):this.client.emitNextPlayer(nextOne)},ClientController.prototype.initialize=function(){this.socket=io.connect("http://room25:1337/"),that=this,this.socket.on("connectedUser",function(object){that.view.appendUserID(object.me),that.view.refreshUsers(object.users),null!==object.waitingUsers&&object.waitingUsers.length>0&&that.view.manageMultipleGames(object.available,object.users)}),this.socket.on("disconnectedUser",function(user){that.view.deleteUser(user)}),this.socket.on("newCharacter",function(object){that.view.deleteCharacter(object.id,object.name,object.pseudo,object.color)}),this.socket.on("cantPlay",function(){that.DOMView.hideButton()}),this.socket.on("letsPlay",function(){that.DOMView.showButton()}),this.socket.on("everyoneIsOk",function(users){that.DOMView.hideActions();var u={};for(var a in users)if(users.hasOwnProperty(a)&&1==users[a].order){u=users[a];break}that.view.appendTurnOf(u,users,1),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&u.id==that.Helper.GetCurrentID()&&that.socket.emit("noPossibilities",{user:u})}),this.socket.on("play",function(object){LastCoords=object.lastCardsCoords,OtherCoords=object.otherCoords,that.view.redirectToGame(object)}),this.socket.on("canConnect",function(){that.view.allowGame()}),this.socket.on("doNextSentence",function(object){that.view.nextSentence({user:object.user,action:object.action,idTarget:object.idTarget})}),this.socket.on("doNextSentenceController",function(object){that.view.nextSentence({user:object.user,action:object.action,coords:object.coords})}),this.socket.on("playerDeplacer",function(object){that.view.deplacer(object.user)}),this.socket.on("playerPousser",function(object){that.view.pousser(object.userTarget,object.user)}),this.socket.on("playerRegarder",function(object){that.view.regarder(object.user.id,object.coords),that.Helper.GetCurrentID()==object.user.id&&that.socket.emit("nextPlayerOk",object.user)}),this.socket.on("playerController",function(object){that.view.controller(object.users,object.coords,object.sens),that.Helper.GetCurrentID()==object.user.id&&that.socket.emit("nextPlayerOk",object.user)}),this.socket.on("nextPlayer",function(object){that.DOMView.hideActions(),that.view.appendTurnOf(object.user,object.users,1),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&object.user.id==that.Helper.GetCurrentID()&&that.socket.emit("noPossibilities",object)}),this.socket.on("nextPlayer2",function(object){that.DOMView.hideActions(),that.view.appendTurnOf(object.user,object.users,2),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&object.user.id==that.Helper.GetCurrentID()&&that.socket.emit("noPossibilities",object)}),this.socket.on("nextTurn",function(object){that.view.nextTurn(object)}),this.socket.on("gardienWins",function(){that.DOMView.appendGardienWins()}),this.socket.on("userCentral",function(user){that.view.deplacer(user),that.Helper.GetCurrentID()==user.id&&that.socket.emit("nextPlayerOk",object.user)}),this.socket.on("exchangeTuile",function(object){that.view.exchangeTuileAndUsers(object.users,object.user,object.lastCoords),that.Helper.GetCurrentID()==object.user.id&&that.socket.emit("nextPlayerOk",object.user)}),this.socket.on("exchangeAndApplyTuile",function(object){that.view.exchangeAndApplyTuileAndUsers(object.users,object.user,object.lastCoords,object.newCoords),that.Helper.GetCurrentID()==object.user.id&&that.socket.emit("nextPlayerOk",object.user)}),this.socket.on("tokenPut",function(object){that.view.appendTokenPut(object)}),this.socket.on("killToken",function(positions){that.view.deleteTokens(positions)})},ClientController.prototype.newUser=function(name){this.socket.emit("readyToPlay",{name:name})},ClientController.prototype.validateAction=function(id,action1,action2){this.socket.emit("playerReady",{id:id,action1:action1,action2:action2})},ClientController.prototype.characterChoosen=function(name,id,color){this.socket.emit("characterChoosen",{name:name,id:id,color:color})},ClientController.prototype.play=function(){this.socket.emit("emitPlay")},ClientController.prototype.emitAction=function(element){var action=element.attr("data-action"),that=this;if("Déplacer"===action||"Regarder"===action)this.socket.emit("doAction",{id:that.Helper.GetCurrentID(),action:action,coords:element.parent().attr("data-position")}),$(".selectMe").remove();else if("Contrôller"===action)this.socket.emit("getUserAndDoNextSentenceController",{id:that.Helper.GetCurrentID(),action:action,coords:element.parent().attr("data-position")});else if("Pousser"===action&&element.parent().hasClass("character")){var idTarget=element.parent().removeClass("character").attr("class").split("-")[1];element.parent().addClass("character"),this.socket.emit("getUserAndDoNextSentence",{id:that.Helper.GetCurrentID(),action:action,idTarget:idTarget})}else"regarderMaster"===action?(this.view.regarder(that.Helper.GetCurrentID(),element.parent().attr("data-position")),$(".selectMe").remove()):"controllerMaster"===action?(this.DOMView.appendTmpMessage(this.resources.chooseDirection),this.socket.emit("getUserAndDoNextSentenceController",{id:that.Helper.GetCurrentID(),action:"Contrôller",coords:element.parent().attr("data-position")})):"teleporter"===action?(this.socket.emit("exchangeTuile",{id:this.Helper.GetCurrentID(),coords:element.parent().attr("data-position")}),$(".selectMe").remove()):"exchange"===action?(this.socket.emit("exchangeAndApplyTuile",{id:this.Helper.GetCurrentID(),coords:element.parent().attr("data-position")}),$(".selectMe").remove()):(this.socket.emit("doAction",{id:that.Helper.GetCurrentID(),action:action,coords:element.parent().attr("data-position"),idTarget:$(".characterSelectMe").parent().removeClass("character").attr("class").split("-")[1]}),$(".characterSelectMe").parent().addClass("character"),$(".selectMe").remove(),$(".characterSelectMe").remove())},ClientController.prototype.emitComplexAction=function(object){var that=this;this.socket.emit("doAction",{id:that.Helper.GetCurrentID(),action:object.action,sens:object.sens,coords:object.position}),$(".selectMe").remove(),$(".sensArrows").remove()},ClientController.prototype.emitDeath=function(user){this.socket.emit("killUser",user)},ClientController.prototype.emitGoToCentral=function(user){this.socket.emit("goToCentral",user)},ClientController.prototype.emitDeathForFirstHere=function(user){this.socket.emit("deathForFirstHere",user),setTimeout(this.emitNextPlayer,200,user,this)},ClientController.prototype.emitNextPlayer=function(user,that){that?that.socket.emit("nextPlayerOk",user):this.socket.emit("nextPlayerOk",user)},ClientController.prototype.emitToken=function(color,positions){this.socket.emit("tokenPut",{color:color,coords:positions,userId:this.Helper.GetCurrentID()})},ClientController.prototype.emitKillToken=function(positions){this.socket.emit("killToken",positions)},CoordsProvider.prototype.getCoordsController=function(u){var coords=[];return 2!=u.position.x&&2!=u.position.y?(coords.push({x:u.position.x,y:0},{x:u.position.x,y:1},{x:u.position.x,y:2},{x:u.position.x,y:3},{x:u.position.x,y:4}),coords.push({x:0,y:u.position.y},{x:1,y:u.position.y},{x:2,y:u.position.y},{x:3,y:u.position.y},{x:4,y:u.position.y})):2!=u.position.x&&2==u.position.y?coords.push({x:u.position.x,y:0},{x:u.position.x,y:1},{x:u.position.x,y:2},{x:u.position.x,y:3},{x:u.position.x,y:4}):2==u.position.x&&2!=u.position.y?coords.push({x:0,y:u.position.y},{x:1,y:u.position.y},{x:2,y:u.position.y},{x:3,y:u.position.y},{x:4,y:u.position.y}):coords.push({x:2,y:0},{x:2,y:1},{x:2,y:3},{x:2,y:4},{x:0,y:2},{x:1,y:2},{x:3,y:2},{x:4,y:2}),coords},CoordsProvider.prototype.getCoordsDeplacerRegarder=function(u){var coords=[];return 1*u.position.x>0&&coords.push({x:1*u.position.x-1,y:1*u.position.y}),1*u.position.x<4&&coords.push({x:1*u.position.x+1,y:1*u.position.y}),1*u.position.y>0&&coords.push({x:1*u.position.x,y:1*u.position.y-1}),1*u.position.y<4&&coords.push({x:1*u.position.x,y:1*u.position.y+1}),coords},CoordsProvider.prototype.getAllCoords=function(){var coords=[];return coords.push({x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:0,y:4},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:1,y:3},{x:1,y:4},{x:2,y:0},{x:2,y:1},{x:2,y:3},{x:2,y:4},{x:3,y:0},{x:3,y:1},{x:3,y:2},{x:3,y:3},{x:3,y:4},{x:4,y:0},{x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4}),coords},CoordsProvider.prototype.getAllControllerCoords=function(){var coords=[];return coords.push({x:0,y:0},{x:0,y:1},{x:0,y:3},{x:0,y:4},{x:1,y:0},{x:1,y:1},{x:1,y:3},{x:1,y:4},{x:3,y:0},{x:3,y:1},{x:3,y:3},{x:3,y:4},{x:4,y:0},{x:4,y:1},{x:4,y:3},{x:4,y:4}),coords},CoordsProvider.prototype.removeVisibleCoords=function(coords,helper){var newCoords=[];for(var i in coords)coords.hasOwnProperty(i)&&helper.GetTuile(coords[i].x,coords[i].y).children(".ng-hide").attr("id")&&helper.GetTuile(coords[i].x,coords[i].y).children(".ng-hide").attr("id").length>0&&newCoords.push(coords[i]);return newCoords},DOMView.prototype.showButton=function(){$(".btn").fadeIn(200,function(){$(".btn").css("display","block")})},DOMView.prototype.hideButton=function(){$(".btn").fadeOut(200)},DOMView.prototype.showButtonOk=function(){$(".btnOk").fadeIn("slow",function(){$(".btnOk").css("display","block")})},DOMView.prototype.hideButtonOk=function(){$(".btnOk").fadeOut("slow")},DOMView.prototype.disableActions=function(){$(".actions").append('<div class="loading"><p>'+this.resources.waiting+'</p><img src="Images/loader.gif" alt="loader"></div>')},DOMView.prototype.hideActions=function(){$(".loading img").remove(),$(".btnOk").fadeOut("slow"),$(".loading p").html(this.resources.go)},DOMView.prototype.appendGardienWins=function(){$(".gameboard").append('<p class="tmpMessage">'+this.resources.guardiansWins+"</p>")},DOMView.prototype.appendTmpMessage=function(message){$(".gameboard").append('<p class="tmpMessage tmp">'+message+"</p>"),setTimeout(function(){$(".tmpMessage.tmp").fadeOut("slow",function(){$(this).remove()})},3e3)},ErrorView.prototype.manageLoginError=function(){$("#newName").css({color:"red","box-shadow":"0 0 5px red","-webkit-box-shadow":"0 0 5px red","-moz-box-shadow":"0 0 5px red","-o-box-shadow":"0 0 5px red"}),$("#newName").attr("placeholder",this.resources.errorLogin)},HelperController.prototype.GetCurrentID=function(){return $(".userID").val()},HelperController.prototype.SetCurrentID=function(id){$(".userID").attr("value",id)},HelperController.prototype.GetCharacterDiv=function(id){return $(null!==id&&id>=0?".character-"+id:".character-"+this.GetCurrentID())},HelperController.prototype.GetTuile=function(x,y){return $(null!==x&&x>=0&&null!==y&&y>=0?'.tuile[data-position="'+x+"-"+y+'"]':'.tuile[data-position="2-2"]')},HelperController.prototype.GetAction=function(action){return $(action?'.actions .action img[alt="'+action+'"]':".actions .action img")},MainView.prototype.setCaseEffect=function(ce){this.CaseEffect=ce},MainView.prototype.appendUserID=function(user){var that=this;that.Helper.SetCurrentID(user.id)},MainView.prototype.manageMultipleGames=function(available,users){var that=this;if(available)$(".hideCharacters").css("display","none");else{var message=this.resources.alreadyAGame,inAPartyUsers=[];for(var u in users)users.hasOwnProperty(u)&&users[u].inAParty&&inAPartyUsers.push(users[u]);for(var uu in inAPartyUsers)inAPartyUsers.hasOwnProperty(uu)&&inAPartyUsers[uu].id!=that.Helper.GetCurrentID()&&(message+=inAPartyUsers[uu].name,uu==inAPartyUsers.length-2?message+=that.resources.and:uu<inAPartyUsers.length-2&&(message+=", "));message+=this.resources.waitForEnd,$(".hideCharacters p").html(message),$(".hideCharacters").css("display","block")}},MainView.prototype.allowGame=function(){$(".hideCharacters").fadeOut("slow"),$(".characterTaken").remove()},MainView.prototype.deleteCharacter=function(id,name,pseudo,color){$("ul.personnage li").each(function(){$(this).children("span").text()==name&&($(".characterTaken-"+id).remove(),$(this).append('<div class="characterTaken characterTaken-'+id+'" style="background:'+color+';opacity:0.6;"><p>'+pseudo+"</p></div>"))})},MainView.prototype.deleteUser=function(user){$(".characterTaken-"+user.id).remove(),this.Helper.GetCharacterDiv(user.id).addClass("dead"),this.DOMView.appendTmpMessage(this.resources.thePlayerIsDead.replace("{0}",user.name))},MainView.prototype.refreshUsers=function(users){var that=this;for(var u in users)users.hasOwnProperty(u)&&""!==users[u].character&&that.usersLoop(users,u)},MainView.prototype.usersLoop=function(users,u){$("ul.personnage li").each(function(){var element=$(this);element.children("span").text()==users[u].character&&0===$(".characterTaken-"+users[u].id).length&&element.append('<div class="characterTaken characterTaken-'+users[u].id+'" style="background:'+users[u].color+';opacity:0.6;"><p>'+users[u].name+"</p></div>")})},MainView.prototype.redirectToGame=function(object){var that=this,userId=that.Helper.GetCurrentID();$(".readyToPlay").val(object.users[0].id),$(".readyToPlay").trigger("change"),setTimeout(function(){that.Helper.SetCurrentID(userId),that.showPlayers(object),that.showIdentity(object.users,userId),$(".coordsReady").val(1),$(".coordsReady").trigger("change");var video=$("video.webcam");for(var u in object.users)object.users.hasOwnProperty(u)&&$(".camContainer").append(video.clone().addClass("webcam-"+object.users[u].id));video.remove(),this.Rtc.initialize(this.Helper.GetCurrentID())},500)},MainView.prototype.nextTurn=function(object){$(".tourRestant").html(this.resources.itRestTours.replace("{0}",object.nbTourRestant)),$(".actions .action").fadeIn("slow"),this.Helper.GetAction().fadeIn("slow"),$(".actions .action").children("p").remove(),$(".extendWidth").removeClass("extendWidth"),$(".action1-final > img, .action2-final > img").remove(),$(".actions .action").each(function(){$(this).removeClass("ok").removeClass("actionOk-1").removeClass("actionOk-2")})},MainView.prototype.showPlayers=function(object){var that=this,cpt=0;for(var u in object.users)if(object.users.hasOwnProperty(u)){$(".gameboard").append(object.users[u].id!=that.Helper.GetCurrentID().parseInt()?'<div class="character character-'+object.users[u].id+'" data-color="'+object.users[u].color+'" style="opacity: 0.8;background:'+object.users[u].color+';">'+object.users[u].name+"</div>":'<div class="myCharacter character character-'+object.users[u].id+'" data-color="'+object.users[u].color+'" style="opacity: 0.8;background:'+object.users[u].color+';">'+object.users[u].name+"</div>");var userDIV=that.Helper.GetCharacterDiv(object.users[u].id);cpt>=3?(userDIV.css("left",2*that.caseWidth+(cpt-3)*$(".character").outerWidth()+"px"),userDIV.css("top",2*that.caseHeight+$(".character").outerWidth()+"px")):(userDIV.css("left",2*that.caseWidth+cpt*$(".character").outerWidth()+"px"),userDIV.css("top",2*that.caseHeight+"px")),cpt++}},MainView.prototype.showIdentity=function(users,meID){for(var u in users)users.hasOwnProperty(u)&&users[u].id==meID&&($(".identity img").attr("src","Images/Identities/"+users[u].identity+".gif").attr("title",users[u].identity),$(".pseudo p").html(users[u].name))},MainView.prototype.animateAction=function(element,toggle){{var isAction1=0===$(".action1-final > img").length;0===$(".action2-final > img").length}if(toggle){var img=element.children("img");if(isAction1)$(".action1-final").append(img.clone());else{if("noSecondAction"==this.Helper.GetCharacterDiv(this.Helper.GetCurrentID()).attr("handicap"))return!0;$(".action2-final").append(img.clone())}element.children("img").fadeOut("slow"),element.addClass("ok").addClass("actionOk-"+$(".action.ok").length)}else{var title=element.attr("title");isAction1,element.remove(),$('.action img[title="'+title+'"]').fadeIn("slow"),$('.action img[title="'+title+'"]').parent().removeClass("actionOk-"+$('.action img[title="'+title+'"]').parent().attr("class").split(" ").last().split("-").last()).removeClass("ok")}},MainView.prototype.appendTurnOf=function(u,users,actionNumber){var that=this;if($(".tourDe p").html(this.resources.turnOf+u.name),u.id==$(".userID").val()){$(".loading").remove(),$(".actions .action").fadeOut("slow");var actionDIV,characterDiv=(that.Helper.GetCurrentID(),that.Helper.GetCharacterDiv(idu));if(1==actionNumber){if("noSee"===characterDiv.attr("handicap")&&"Regarder"===u.action1)return!0;"deathAfterNextAction"===characterDiv.attr("handicap")&&"Déplacer"!==u.action1&&this.CaseEffect.client.emitDeath(u),"deathAfterNextTour"===characterDiv.attr("handicap")&&characterDiv.attr("handicap","deathAfterThisTour"),actionDIV=that.Helper.GetAction(u.action1),actionDIV.parent().fadeIn(100).append("<p>"+actionDIV.parent().attr("data-first-sentence")+"</p>"),actionDIV.parent().parent().addClass("extendWidth")}else{if("noSee"===characterDiv.attr("handicap")&&"Regarder"===u.action2)return!0;("deathAfterNextAction"===characterDiv.attr("handicap")&&"Déplacer"!==u.action2||"deathAfterThisTour"===characterDiv.attr("handicap")&&"Déplacer"!==u.action2)&&this.CaseEffect.client.emitDeath(u),actionDIV=that.Helper.GetAction(u.action2),actionDIV.parent().fadeIn(100).append("<p>"+actionDIV.parent().attr("data-first-sentence")+"</p>"),actionDIV.parent().parent().addClass("extendWidth")}manageTurn(u,users,this.Helper,this.CoordsProvider)}},MainView.prototype.nextSentence=function(object){var that=this,actionDIV=that.Helper.GetAction(object.action);actionDIV.parent().children("p").html(actionDIV.parent().attr("data-second-sentence")),manageComplexAction(object,this.Helper,this.CoordsProvider)},MainView.prototype.deplacer=function(user){var that=this;this.Helper.GetCharacterDiv(user.id).animate({top:that.caseHeight*user.position.y+"px",left:that.caseWidth*user.position.x+"px"},500,function(){for(;that.someoneHere(user);)that.moveUser(user)});var tuile=this.Helper.GetTuile(user.position.x,user.position.y),imgs=tuile.children("img");imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),that.CaseEffect.client.emitKillToken(user.position),this.Helper.GetCharacterDiv(user.id).removeAttr("handicap"),user.id==this.Helper.GetCurrentID()&&that.CaseEffect.manageCaseEffect(user,tuile.attr("data-action"))},MainView.prototype.pousser=function(userTarget,user){var that=this;that.Helper.GetCharacterDiv(userTarget.id).animate({top:that.caseHeight*userTarget.position.y+"px",left:that.caseWidth*userTarget.position.x+"px"},500);var tuile=that.Helper.GetTuile(userTarget.position.x,userTarget.position.y),imgs=tuile.children("img");imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),that.CaseEffect.client.emitKillToken(userTarget.position),this.Helper.GetCharacterDiv(userTarget.id).removeAttr("handicap"),user.id==this.Helper.GetCurrentID()&&that.CaseEffect.manageCaseEffect(userTarget,tuile.attr("data-action"),user)},MainView.prototype.regarder=function(userId,coords){if(!coords&&userId==this.Helper.GetCurrentID())return this.DOMView.appendTmpMessage(this.resources.chooseWhatToSee),coords=this.CoordsProvider.getAllCoords(),appendSelect(coords,"regarderMaster",this.Helper),!0;var that=this,position={x:coords.split("-")[0].parseInt(),y:coords.split("-")[1].parseInt()};if(userId==that.Helper.GetCurrentID()){var imgs=that.Helper.GetTuile(position.x,position.y).children("img");imgs.first().hasClass("ng-hide")&&(imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),setTimeout(function(){imgs.first().addClass("ng-hide"),imgs.first().fadeOut("slow"),imgs.last().fadeIn("slow")},3e3))}},MainView.prototype.controller=function(users,coords,sens){var that=this;if(!coords&&!sens&&users.id==that.Helper.GetCurrentID())return this.DOMView.appendTmpMessage(this.resources.chooseWhatToControl),coords=this.CoordsProvider.getAllControllerCoords(),appendSelect(coords,"controllerMaster",this.Helper),!0;"left"==sens||"right"==sens?$(".tuile").each(function(){var x=$(this).attr("data-position").split("-")[0].parseInt(),y=$(this).attr("data-position").split("-")[1].parseInt();y==coords.split("-")[1].parseInt()&&(0===x&&"left"===sens?x=4:4===x&&"right"===sens?x=0:"left"===sens?x-=1:x+=1,$(this).attr("data-position",x+"-"+y),$(this).addClass("moved"))}):("top"===sens||"bottom"===sens)&&$(".tuile").each(function(){var x=$(this).attr("data-position").split("-")[0].parseInt(),y=$(this).attr("data-position").split("-")[1].parseInt();x==coords.split("-")[0].parseInt()&&(0===y&&"top"===sens?y=4:4===y&&"bottom"===sens?y=0:"top"===sens?y-=1:y+=1,$(this).attr("data-position",x+"-"+y),$(this).addClass("moved"))}),$(".moved").each(function(){$(this).animate({top:$(this).attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:$(this).attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500)});for(var u in users)users.hasOwnProperty(u)&&that.Helper.GetCharacterDiv(users[u].id).animate({top:1*users[u].position.y*that.caseHeight,left:1*users[u].position.x*that.caseWidth},500);setTimeout(function(){for(var u in users)if(users.hasOwnProperty(u))for(;that.someoneHere(users[u]);)that.moveUser(users[u])},500),setTimeout(function(){$(".moved").removeClass("moved")},200)},MainView.prototype.exchangeTuileAndUsers=function(users,user,lastCoords){var futurTuile=this.Helper.GetTuile(user.position.x,user.position.y),lastTuile=this.Helper.GetTuile(lastCoords.split("-")[0],lastCoords.split("-")[1]),that=this;lastTuile.animate({top:futurTuile.attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:futurTuile.attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500),futurTuile.animate({top:lastTuile.attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:lastTuile.attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500);for(var u in users)users.hasOwnProperty(u)&&that.Helper.GetCharacterDiv(users[u].id).animate({top:1*users[u].position.y*that.caseHeight+"px",left:1*users[u].position.x*that.caseWidth+"px"},500);lastTuile.attr("data-position",futurTuile.attr("data-position")),futurTuile.attr("data-position",lastCoords),setTimeout(function(){for(var u in users)if(users.hasOwnProperty(u))for(;that.someoneHere(users[u]);)that.moveUser(users[u])},500)},MainView.prototype.exchangeAndApplyTuileAndUsers=function(users,user,lastCoords,newCoords){var futurTuile=this.Helper.GetTuile(newCoords.split("-")[0],newCoords.split("-")[1]),lastTuile=this.Helper.GetTuile(lastCoords.split("-")[0],lastCoords.split("-")[1]),that=this;lastTuile.animate({top:futurTuile.attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:futurTuile.attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500),futurTuile.animate({top:lastTuile.attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:lastTuile.attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500),lastTuile.attr("data-position",futurTuile.attr("data-position")),futurTuile.attr("data-position",lastCoords);var imgs=futurTuile.children("img");imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),user.id==this.Helper.GetCurrentID()&&that.CaseEffect.manageCaseEffect(user,futurTuile.attr("data-action"))
},MainView.prototype.exchangeTuile=function(u){return u.id==this.Helper.GetCurrentID()?(this.DOMView.appendTmpMessage(this.resources.chooseWhereToGo),coords=this.CoordsProvider.getAllCoords(),coords=this.CoordsProvider.removeVisibleCoords(coords,this.Helper),appendSelect(coords,"teleporter",this.Helper),0===$(".selectMe").length&&this.CaseEffect.client.socket.emit("noPossibilities",{user:u}),!0):void 0},MainView.prototype.exchangeAndApplyTuile=function(id){return id==this.Helper.GetCurrentID()?(this.DOMView.appendTmpMessage(this.resources.chooseExchange),coords=this.CoordsProvider.getAllCoords(),coords=this.CoordsProvider.removeVisibleCoords(coords,this.Helper),appendSelect(coords,"exchange",this.Helper),!0):void 0},MainView.prototype.someoneHere=function(user){var anybody=!1,$user=this.Helper.GetCharacterDiv(user.id);return $(".character").each(function(){$(this).css("top")!=$user.css("top")||$(this).css("left")!=$user.css("left")||$(this).hasClass("character-"+user.id)||(anybody=!0)}),anybody},MainView.prototype.moveUser=function(user){var userDIV=this.Helper.GetCharacterDiv(user.id);userDIV.css("left",userDIV.css("left").substr(0,userDIV.css("left").length-2).parseInt()+50+"px")},MainView.prototype.appendSelectToken=function(){var color=this.Helper.GetCharacterDiv().data("color"),coords=this.CoordsProvider.removeVisibleCoords(this.CoordsProvider.getAllCoords(),this.Helper),that=this;for(var c in coords)if(coords.hasOwnProperty(c)){var tuile=that.Helper.GetTuile(coords[c].x,coords[c].y);tuile.append('<div class="selectMeToken" style="background:'+color+';opacity: 0.4;"></div>')}},MainView.prototype.appendTokenPut=function(object){var x=object.coords.split("-").first(),y=object.coords.split("-").last(),tuile=this.Helper.GetTuile(x,y);tuile.append('<div class="tokenuser" data-token="'+object.userId+'" style="opacity: 0.8;background:'+object.color+';"></div>'),tuile.data("tokenuser",object.userId)},MainView.prototype.deleteTokens=function(positions){var tuile=this.Helper.GetTuile(positions.x,positions.y),userId=tuile.data("tokenuser");tuile.children(".tokenuser").remove(),tuile.removeAttr("data-tokenuser"),this.Helper.GetCurrentID()==userId&&$(".putAToken").removeClass("hideToken")},RtcController.prototype.initialize=function(idU){this.Adapter.initialize(),this.callButton.disabled=!0,this.hangupButton.disabled=!0,this.startButton.onclick=this.start,this.callButton.onclick=this.call,this.hangupButton.onclick=this.hangup;var videos=$("video"),that=this;this.videoLocal=$("video.webcam-"+idU),videos.each(function(){$(this).hasClass("webcam-"+idU)||that.videosRemote.push($(this))})},RtcController.prototype.gotStream=function(stream){this.trace("Received local stream"),this.Adapter.attachMediaStream(this.videoLocal,stream),window.localstream=stream,this.callButton.disabled=!1},RtcController.prototype.start=function(){this.trace("Requesting local stream"),this.startButton.disabled=!0,getUserMedia({audio:!0,video:!0},this.gotStream,function(e){console.log("getUserMedia() error: ",e)})},RtcController.prototype.call=function(){this.callButton.disabled=!0,this.hangupButton.disabled=!1,this.trace("Starting calls");var audioTracks=window.localstream.getAudioTracks(),videoTracks=window.localstream.getVideoTracks();audioTracks.length>0&&this.trace("Using audio device: "+audioTracks[0].label),videoTracks.length>0&&this.trace("Using video device: "+videoTracks[0].label);var servers=null,that=this;this.pcLocal=new RTCPeerConnection(servers),this.pcLocal.onicecandidate=this.iceCallbackLocal,this.videosRemote.each(function(){var idU=$(this).attr("class").split("-")[1];that.pcRemote.push({id:idU,rtc:new RTCPeerConnection(servers),onaddstream:that.gotRemoteStream,onicecandidate:that.iceCallbackRemote})}),this.trace("pc1: created local and remote peer connection objects"),this.pcLocal.addStream(window.localstream),this.trace("Adding local stream to pc1Local"),this.pcLocal.createOffer(this.gotDescriptionLocal,this.onCreateSessionDescriptionError)},RtcController.prototype.hangup=function(){var that=this;this.trace("Ending calls"),pcLocal.close();for(var i in that.pcRemote)that.pcRemote.hasOwnProperty(i)&&that.pcRemote[i].rtc.close();pcLocal=null,pcRemote=null,hangupButton.disabled=!0,callButton.disabled=!1},RtcController.prototype.gotDescriptionLocal=function(desc){this.pcLocal.setLocalDescription(desc),this.trace("Offer from pcLocal \n"+desc.sdp);var that=this;for(var i in that.pcRemote)that.pcRemote.hasOwnProperty(i)&&(that.pcRemote[i].rtc.setRemoteDescription(desc),that.pcRemote[i].rtc.createAnswer(that.gotDescriptionRemote,that.onCreateSessionDescriptionError,that.sdpConstraints))},RtcController.prototype.gotDescriptionRemote=function(desc){this.pcRemote.setLocalDescription(desc),this.trace("Answer from pcRemote \n"+desc.sdp),this.pcLocal.setRemoteDescription(desc)},RtcController.prototype.gotRemoteStream=function(e){this.Adapter.attachMediaStream(video2,e.stream),this.trace("pc1: received remote stream")},RtcController.prototype.iceCallbackLocal=function(event){this.handleCandidate(event.candidate,pc1Remote,"pc1: ","local")},RtcController.prototype.iceCallbackRemote=function(event){this.handleCandidate(event.candidate,this.pcLocal,"pc1: ","remote")},RtcController.prototype.handleCandidate=function(candidate,dest,prefix,type){candidate&&(dest.addIceCandidate(new RTCIceCandidate(candidate),this.onAddIceCandidateSuccess,this.onAddIceCandidateError),this.trace(prefix+"New "+type+" ICE candidate: "+candidate.candidate))},RtcController.prototype.onCreateSessionDescriptionError=function(error){this.trace("Failed to create session description: "+error.toString())},RtcController.prototype.onAddIceCandidateSuccess=function(){this.trace("AddIceCandidate success.")},RtcController.prototype.onAddIceCandidateError=function(error){this.trace("Failed to add ICE candidate: "+error.toString())},RtcAdapterController.prototype.trace=function(text){if("\n"===text[text.length-1]&&(text=text.substring(0,text.length-1)),window.performance){var now=(window.performance.now()/1e3).toFixed(3);console.log(now+": "+text)}else console.log(text)},RtcAdapterController.prototype.initialize=function(){navigator.mozGetUserMedia?this.manageRTCFirefox():navigator.webkitGetUserMedia?this.manageRTCWebkit():console.log("Browser does not appear to be WebRTC-capable"),"undefined"!=typeof module&&(module.exports={RTCPeerConnection:RTCPeerConnection,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion})},RtcAdapterController.prototype.manageRTCFirefox=function(){console.log("This appears to be Firefox"),this.webrtcDetectedBrowser="firefox",this.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),this.webrtcMinimumVersion=31;var that=this;if(window.RTCPeerConnection=function(pcConfig,pcConstraints){if(that.webrtcDetectedVersion<38&&pcConfig&&pcConfig.iceServers){for(var newIceServers=[],i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(server.hasOwnProperty("urls"))for(var j=0;j<server.urls.length;j++){var newServer={url:server.urls[j]};0===server.urls[j].indexOf("turn")&&(newServer.username=server.username,newServer.credential=server.credential),newIceServers.push(newServer)}else newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new mozRTCPeerConnection(pcConfig,pcConstraints)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=this.webrtcDetectedVersion<38?function(c,onSuccess,onError){var constraintsToFF37=function(c){if("object"!=typeof c||c.require)return c;var require=[];return Object.keys(c).forEach(function(key){var r=c[key]="object"==typeof c[key]?c[key]:{ideal:c[key]};if(void 0!==r.exact&&(r.min=r.max=r.exact,delete r.exact),(void 0!==r.min||void 0!==r.max)&&require.push(key),void 0!==r.ideal){c.advanced=c.advanced||[];var oc={};oc[key]={min:r.ideal,max:r.ideal},c.advanced.push(oc),delete r.ideal,Object.keys(r).length||delete c[key]}}),require.length&&(c.require=require),c};return console.log("spec: "+JSON.stringify(c)),c.audio=constraintsToFF37(c.audio),c.video=constraintsToFF37(c.video),console.log("ff37: "+JSON.stringify(c)),navigator.mozGetUserMedia(c,onSuccess,onError)}:navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){var infos=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];resolve(infos)})},this.webrtcDetectedVersion<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().catch(function(e){if("NotFoundError"===e.name)return[];throw e})}}RtcAdapterController.prototype.attachMediaStream=function(element,stream){console.log("Attaching media stream"),element.mozSrcObject=stream},RtcAdapterController.prototype.reattachMediaStream=function(to,from){console.log("Reattaching media stream"),to.mozSrcObject=from.mozSrcObject}},RtcAdapterController.prototype.manageRTCWebkit=function(){console.log("This appears to be Chrome"),this.webrtcDetectedBrowser="chrome",this.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),this.webrtcMinimumVersion=38,window.RTCPeerConnection=function(pcConfig,pcConstraints){return new webkitRTCPeerConnection(pcConfig,pcConstraints)},["createOffer","createAnswer"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var self=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var opts=1===arguments.length?arguments[0]:void 0;return new Promise(function(resolve,reject){nativeMethod.apply(self,[resolve,reject,opts])})}return nativeMethod.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var args=arguments,self=this;return new Promise(function(resolve,reject){nativeMethod.apply(self,[args[0],function(){resolve(),args.length>=2&&args[1].apply(null,[])},function(err){reject(err),args.length>=3&&args[2].apply(null,[err])}])})}}),getUserMedia=function(c,onSuccess,onError){var constraintsToChrome=function(c){if("object"!=typeof c||c.mandatory||c.optional)return c;var cc={};return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key){var r="object"==typeof c[key]?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var oldname=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];var oc={};"number"==typeof r.ideal?(oc[oldname("min",key)]=r.ideal,cc.optional.push(oc),oc={},oc[oldname("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname("",key)]=r.exact):["min","max"].forEach(function(mix){void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname(mix,key)]=r[mix])})}}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc};return console.log("spec:   "+JSON.stringify(c)),c.audio=constraintsToChrome(c.audio),c.video=constraintsToChrome(c.video),console.log("chrome: "+JSON.stringify(c)),navigator.webkitGetUserMedia(c,onSuccess,onError)},navigator.getUserMedia=getUserMedia,RtcAdapterController.prototype.attachMediaStream=function(element,stream){"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.log("Error attaching stream to element.")},RtcAdapterController.prototype.reattachMediaStream=function(to,from){to.src=from.src},navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(resolve){var kinds={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(devices){resolve(devices.map(function(device){return{label:device.label,kind:kinds[device.kind],deviceId:device.id,groupId:""}}))})})}})},RtcAdapterController.prototype.requestUserMedia=function(constraints){return new Promise(function(resolve,reject){getUserMedia(constraints,resolve,reject)})},function(){"use strict";angular.module("Room25App").controller("CharacterCtrl",function($scope,$http,$location){$scope.characters=[],$scope.readyToPlay=-1,$http({method:"GET",url:"Json/characters.json"}).success(function(data){$scope.characters=data}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)}),$scope.$watch("readyToPlay",function(newValue){newValue>=0&&(newValue==document.getElementById("userID").value?($scope.readyToPlay=newValue,$location.path("/game")):($scope.readyToPlay=newValue,$location.path("/game/join")))},!0)})}(),function(){"use strict";angular.module("Room25App").controller("GameCtrl",function($scope,$http){function getTuiles(data,last){var array=[];for(var t in data)data.hasOwnProperty(t)&&data[t].last===last&&array.push(data[t]);return array}$scope.tuiles=[],$scope.actions=[],$scope.coordsReady=-1,$http({method:"GET",url:"Json/actions.json"}).success(function(data){$scope.actions=data}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)}),$scope.$watch("coordsReady",function(newValue){-1!==newValue&&$http({method:"GET",url:"Json/tuiles.json"}).success(function(data){$scope.tuiles=$scope.mixTuiles(data,LastCoords,OtherCoords)}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)})},!0),$scope.mixTuiles=function(data,last,other){var realTuile=getTuiles(data,!0);for(var t in realTuile)realTuile.hasOwnProperty(t)&&(realTuile[t].position.x=last[t].x,realTuile[t].position.y=last[t].y);var otherTuile=getTuiles(data,!1);for(var tu in otherTuile)otherTuile.hasOwnProperty(tu)&&(otherTuile[tu].position.x=other[tu].x,otherTuile[tu].position.y=other[tu].y);return realTuile.concat(otherTuile).concat(getTuiles(data,null))}})}(),function(){"use strict";angular.module("Room25App").controller("HelpCtrl",function(){})}(),function(){"use strict";var app=angular.module("Room25App",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"Views/home.html"}).when("/game",{templateUrl:"Views/game.html",reloadOnSearch:!1}).when("/game/join",{templateUrl:"Views/game.html",reloadOnSearch:!1}).when("/help",{templateUrl:"Views/help.html",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}),app.controller("MainCtrl",function(){})}();var coordsManager=function(){this.getForVIPCases=function(){return[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:4,y:0},{x:3,y:0},{x:4,y:1},{x:4,y:4},{x:4,y:3},{x:3,y:4},{x:1,y:4},{x:0,y:4},{x:0,y:3}]},this.getForOtherCases=function(){return[{x:2,y:0},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:0,y:2},{x:1,y:2},{x:3,y:2},{x:4,y:2},{x:1,y:3},{x:2,y:3},{x:3,y:3},{x:2,y:4}]},this.shufflePositions=function(coords){for(var j=0,valI="",valJ=valI,l=coords.length-1;l>-1;)j=Math.floor(Math.random()*l),valI=coords[l],valJ=coords[j],coords[l]=valJ,coords[j]=valI,l-=1;return coords},this.findInArray=function(array,position){var positionTmp=null;for(var a in array)if(array.hasOwnProperty(a)&&array[a].x==position.x&&array[a].y==position.y){positionTmp=a;break}return positionTmp},this.manageCoords=function(){var coordsPossible=this.getForVIPCases();coordsPossible=this.shufflePositions(coordsPossible);var lastCardsCoords=[];lastCardsCoords.push(coordsPossible[0]),lastCardsCoords.push(coordsPossible[1]);var otherCoords=this.getForOtherCases();return otherCoords=otherCoords.concat(coordsPossible),otherCoords=this.shufflePositions(otherCoords),otherCoords=this.deleteLastCardsCoords(otherCoords,lastCardsCoords),[lastCardsCoords,otherCoords]},this.deleteLastCardsCoords=function(arrayFrom,arrayTo){var arrayReturn=[],that=this;for(var t in arrayFrom)arrayFrom.hasOwnProperty(t)&&(that.findInArray(arrayTo,arrayFrom[t])||arrayReturn.push(arrayFrom[t]));return arrayReturn},this.getNewUserPositionAfterController=function(user,sens){return"top"==sens?user.position.y=user.position.y>0?1*user.position.y-1:4:"bottom"==sens?user.position.y=user.position.y<4?1*user.position.y+1:0:"left"==sens?user.position.x=user.position.x>0?1*user.position.x-1:4:"right"==sens&&(user.position.x=user.position.x<4?1*user.position.x+1:0),user}};exports.coordsManager=coordsManager;var debugManager=function(){this.debugArray=function(array){for(var a in array)console.log(a+" -> "+array[a])},this.debugObject=function(object){var props="";for(var prop in object)props+=prop+" => "+object[prop]+"\n";console.log(props)},this.debugArrayOfObject=function(array){var that=this;for(var a in array)that.debugObject(array[a])},this.messageForUser=function(user,message){console.log("L'utilisateur "+user.id+" : "+user.name+" "+message)}};exports.debugManager=debugManager;var gameManager=function(){this.everyoneIsOk=function(users){var ready=!0;for(var a in users)if(users.hasOwnProperty(a)&&!users[a].ready){ready=!1;break}return ready},this.everyoneIsNok=function(users){var notReady=!0;for(var a in users)if(users.hasOwnProperty(a)&&users[a].ready){notReady=!1;break}return notReady},this.gardienWins=function(users){var bool=0;for(var u in users)users.hasOwnProperty(u)&&"prisonnier"===users[u].identity&&bool++;return 2>=bool},this.moreThanFourPlayers=function(users){var cpt=0;for(var a in users)users.hasOwnProperty(a)&&""!==users[a].character&&cpt++;return cpt>=4},this.manageIdentity=function(users,shuffleFunction){var identities;identities=4==users.length?["prisonnier","prisonnier","prisonnier","prisonnier","gardien"]:["prisonnier","prisonnier","prisonnier","prisonnier","gardien","gardien"],identities=shuffleFunction(identities);for(var u in users)users.hasOwnProperty(u)&&(users[u].identity=identities[u]);return users}};exports.gameManager=gameManager;var userManager=function(){this.getById=function(users,id){var u=null;for(var a in users)if(users.hasOwnProperty(a)&&users[a].id==id){u=a;break}return u},this.getByOrder=function(users,order){var u=null;for(var a in users)if(users.hasOwnProperty(a)&&users[a].order==order){u=users[a];break}return u},this.getInTheSameRow=function(users,coords,sens){var r=[];if("top"==sens||"bottom"==sens)for(var u in users)users.hasOwnProperty(u)&&users[u].position.x==coords.split("-")[0]&&r.push(u);else if("left"==sens||"right"==sens)for(var u2 in users)users.hasOwnProperty(u2)&&users[u2].position.y==coords.split("-")[1]&&r.push(u2);return r},this.getInTheSameCase=function(users,user){var r=[];for(var u in users)users.hasOwnProperty(u)&&users[u].position.x==user.position.x&&users[u].position.y==user.position.y&&users[u].id!=user.id&&r.push(users[u]);return r},this.processPlayerOrder=function(users,shuffleFunction){users=shuffleFunction(users);for(var i in users)users.hasOwnProperty(i)&&(users[i].order=i,users[i].inAParty=!0);return users},this.killLastUsers=function(users){var that=this;for(var i in users)users.hasOwnProperty(i)&&users[i].inAParty&&users.splice(that.getById(users,users[i].id),1);return users},this.isInParty=function(users){var inAParty=!1;for(var i in users)if(users.hasOwnProperty(i)&&users[i].inAParty){inAParty=!0;break}return inAParty}};exports.userManager=userManager;var LastCoords=[],OtherCoords=[];$(document).ready(function(){var Helper=new HelperController,Coords=new CoordsProvider,ErrView=new ErrorView(Helper),DOM=new DOMView(Helper),View=new MainView(Helper,DOM,Coords),Client=new ClientController(View,DOM,Helper),CaseEffect=new CaseEffectController(Client);View.setCaseEffect(CaseEffect),Client.initialize(),$("body").on("click",".toggle",function(){$(this).parent().outerWidth()>1?($(this).parent().animate({width:"0px"},500),$(this).parent().children("*").addClass("hiddencontent"),$(".toggle").removeClass("hiddencontent")):($(this).parent().animate({width:"200px"},500),$(this).parent().children("*").removeClass("hiddencontent"))}),$("body").on("mouseover",".personnage li",function(){$this=$(this),$(".personnage li").each(function(){$this[0]!=$(this)[0]&&$(this).stop().animate({opacity:"0.6"},200)})}).on("mouseleave",".personnage li",function(){$(".personnage li").stop().animate({opacity:"1"},200)}),$("body").on("click","#getMyName",function(){var patt=/[a-zA-Z\-\'\ ]+/,name=$("#newName").val();return patt.test(name)?($("#popin-grayback").fadeOut("slow"),void Client.newUser(name)):(ErrView.manageLoginError(),!1)}),$("body").on("click","ul.personnage li, .characterTaken",function(e){if(e.stopPropagation(),!$(this).hasClass("characterTaken")){var idU=Helper.GetCurrentID(),characterNameU=$(this).children("span").text(),colorU=$(this).data("color");$(".characterTaken-"+idU).remove(),Client.characterChoosen(characterNameU,idU,colorU)}}),$("body").on("click",".btn",function(){Client.play()}),$("body").on("click",".action",function(){($(".action.ok").length<2||$(this).hasClass("ok"))&&(View.animateAction($(this),!$(this).hasClass("ok")),$(".action.ok").length>0?DOM.showButtonOk():DOM.hideButtonOk())}),$("body").on("click",".action1-final > img, .action2-final > img",function(){View.animateAction($(this),!1),$(".action.ok").length>0?DOM.showButtonOk():DOM.hideButtonOk()}),$("body").on("click",".btnOk",function(){DOM.disableActions();var idU=Helper.GetCurrentID(),action1=$(".actionOk-1").children("img").attr("alt"),action2=$(".actionOk-2").length>0?action2=$(".actionOk-2").children("img").attr("alt"):"";Client.validateAction(idU,action1,action2)}),$("body").on("click",".tuile .selectMe, .character .characterSelectMe",function(){Client.emitAction($(this))}),$("body").on("click",".tuile .selectMeToken",function(){var color=$(this).css("background-color"),positions=$(this).parent().data("position");$(".selectMeToken").remove(),Client.emitToken(color,positions)}),$("body").on("click","span.direction",function(){var element=$(this),action="Contrôller",sens=element.removeClass("direction").attr("class"),position=element.parent().attr("data-position");return element.addClass("direction"),Client.emitComplexAction({element:element,action:action,sens:sens,position:position}),!1}),$("body").on("click",".putAToken",function(){$(this).hasClass("hideToken")||(View.appendSelectToken(),$(this).addClass("hideToken"))})});