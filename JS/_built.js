function CaseEffectController(client){this.client=client}function ClientController(view,helper){this.socket={},this.view=view,this.Helper=helper}function ErrorView(helper){this.Helper=helper,this.divError=$("#error-view")}function HelperController(){}function MainView(helper){this.caseWidth=175,this.caseHeight=175,this.Helper=helper,this.CaseEffect=null}function manageTurn(u,users){var coords=[];if(""!==u.action1)if("Déplacer"===u.action1)coords=getCoordsDeplacerRegarder(u),appendSelect(coords,u.action1);else if("Pousser"===u.action1){for(var a in users)users.hasOwnProperty(a)&&users[a].id!==u.id&&users[a].position.x===u.position.x&&users[a].position.y===u.position.y&&coords.push(users[a]);appendCharacterSelectMe(coords,u.action1)}else"Regarder"===u.action1?(coords=getCoordsDeplacerRegarder(u),appendSelect(coords,u.action1)):"Contrôller"===u.action1&&(coords=getCoordsController(u),appendSelect(coords,u.action1));else if("Déplacer"===u.action2)coords=getCoordsDeplacerRegarder(u),appendSelect(coords,u.action2);else if("Pousser"===u.action2){for(var b in users)users.hasOwnProperty(b)&&users[b].id!==u.id&&users[b].position.x===u.position.x&&users[b].position.y===u.position.y&&coords.push(users[b]);appendCharacterSelectMe(coords,u.action2)}else"Regarder"===u.action2?(coords=getCoordsDeplacerRegarder(u),appendSelect(coords,u.action2)):"Contrôller"===u.action2&&(coords=getCoordsController(u),appendSelect(coords,u.action2))}function manageComplexAction(object){"Pousser"===object.action?(coords=getCoordsDeplacerRegarder(object.user),appendSelect(coords,object.action)):"Contrôller"===object.action&&$(".tourDe").append(object.coords.split("-")[0].parseInt()>object.user.position.x||object.coords.split("-")[0].parseInt()<object.user.position.x?'<p class="sensArrows" data-position='+object.coords+'><span class="right direction">&rarr;</span><span class="left direction">&larr;</span></p>':'<p class="sensArrows" data-position='+object.coords+'><span class="top direction">&uarr;</span><span class="bottom direction">&darr;</span></p>')}function appendSelect(coords,action){var that=this;for(var c in coords)coords.hasOwnProperty(c)&&(that.Helper.GetTuile(coords[c].x,coords[c].y).append('<div class="selectMe" data-action="'+action+'"></div>'),$(".selectMe").animate({width:"175px",height:"175px"},500))}function appendCharacterSelectMe(coords,action){var that=this;for(var c in coords)coords.hasOwnProperty(c)&&that.Helper.GetCharacterDiv(coords[c].id).append('<div class="characterSelectMe" data-action="'+action+'"></div>')}function getCoordsController(u){var coords=[];return 2!=u.position.x&&2!=u.position.y?(coords.push({x:u.position.x,y:0},{x:u.position.x,y:1},{x:u.position.x,y:2},{x:u.position.x,y:3},{x:u.position.x,y:4}),coords.push({x:0,y:u.position.y},{x:1,y:u.position.y},{x:2,y:u.position.y},{x:3,y:u.position.y},{x:4,y:u.position.y})):2!=u.position.x&&2==u.position.y?coords.push({x:u.position.x,y:0},{x:u.position.x,y:1},{x:u.position.x,y:2},{x:u.position.x,y:3},{x:u.position.x,y:4}):2==u.position.x&&2!=u.position.y?coords.push({x:0,y:u.position.y},{x:1,y:u.position.y},{x:2,y:u.position.y},{x:3,y:u.position.y},{x:4,y:u.position.y}):coords.push({x:2,y:0},{x:2,y:1},{x:2,y:3},{x:2,y:4},{x:0,y:2},{x:1,y:2},{x:3,y:2},{x:4,y:2}),coords}function getCoordsDeplacerRegarder(u){var coords=[];return 1*u.position.x>0&&coords.push({x:1*u.position.x-1,y:1*u.position.y}),1*u.position.x<4&&coords.push({x:1*u.position.x+1,y:1*u.position.y}),1*u.position.y>0&&coords.push({x:1*u.position.x,y:1*u.position.y-1}),1*u.position.y<4&&coords.push({x:1*u.position.x,y:1*u.position.y+1}),coords}CaseEffectController.prototype.manageCaseEffect=function(user,effect){},ClientController.prototype.initialize=function(){this.socket=io.connect("http://localhost:1337"),that=this,this.socket.on("connectedUser",function(object){that.view.appendUserID(object.me),that.view.refreshUsers(object.users)}),this.socket.on("disconnectedUser",function(user){that.view.deleteUser(user)}),this.socket.on("newCharacter",function(object){that.view.deleteCharacter(object.id,object.name,object.pseudo)}),this.socket.on("cantPlay",function(){that.view.deleteButton()}),this.socket.on("letsPlay",function(){that.view.showButton()}),this.socket.on("everyoneIsOk",function(users){that.view.hideActions();var u={};for(var a in users)if(users.hasOwnProperty(a)&&1==users[a].order){u=users[a];break}that.view.appendTurnOf(u,users,1),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&u.id==$(".userID").val()&&that.socket.emit("noPossibilities",{user:u})}),this.socket.on("play",function(object){LastCoords=object.lastCardsCoords,OtherCoords=object.otherCoords,that.view.redirectToGame(object)}),this.socket.on("doNextSentence",function(object){that.view.nextSentence({user:object.user,action:object.action,idTarget:object.idTarget})}),this.socket.on("doNextSentenceController",function(object){that.view.nextSentence({user:object.user,action:object.action,coords:object.coords})}),this.socket.on("playerDeplacer",function(object){that.view.deplacer(object.user)}),this.socket.on("playerPousser",function(object){that.view.pousser(object.user)}),this.socket.on("playerRegarder",function(object){that.view.regarder(object.user,object.coords)}),this.socket.on("playerController",function(object){that.view.controller(object.users,object.coords,object.sens)}),this.socket.on("nextPlayer",function(object){that.view.hideActions(),that.view.appendTurnOf(object.user,object.users,1),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&object.user.id==$(".userID").val()&&that.socket.emit("noPossibilities",object)}),this.socket.on("nextPlayer2",function(object){that.view.hideActions(),that.view.appendTurnOf(object.user,object.users,2),0===$(".selectMe").length&&0===$(".characterSelectMe").length&&object.user.id==$(".userID").val()&&that.socket.emit("noPossibilities",object)}),this.socket.on("nextTurn",function(object){that.view.nextTurn(object)})},ClientController.prototype.newUser=function(name){this.socket.emit("readyToPlay",{name:name})},ClientController.prototype.validateAction=function(id,action1,action2){this.socket.emit("playerReady",{id:id,action1:action1,action2:action2})},ClientController.prototype.characterChoosen=function(name,id){this.socket.emit("characterChoosen",{name:name,id:id})},ClientController.prototype.play=function(){this.socket.emit("emitPlay")},ClientController.prototype.emitAction=function(element){var action=element.attr("data-action");if("Déplacer"===action||"Regarder"===action)this.socket.emit("doAction",{id:$(".userID").val(),action:action,coords:element.parent().attr("data-position")}),$(".selectMe").remove();else if("Contrôller"===action)this.socket.emit("getUserAndDoNextSentenceController",{id:$(".userID").val(),action:action,coords:element.parent().attr("data-position")});else if("Pousser"===action&&element.parent().hasClass("character")){var idTarget=element.parent().removeClass("character").attr("class").split("-")[1];element.parent().addClass("character"),this.socket.emit("getUserAndDoNextSentence",{id:$(".userID").val(),action:action,idTarget:idTarget})}else this.socket.emit("doAction",{id:$(".userID").val(),action:action,coords:element.parent().attr("data-position"),idTarget:$(".characterSelectMe").parent().removeClass("character").attr("class").split("-")[1]}),$(".characterSelectMe").parent().addClass("character"),$(".selectMe").remove(),$(".characterSelectMe").remove()},ClientController.prototype.emitComplexAction=function(object){this.socket.emit("doAction",{id:$(".userID").val(),action:object.action,sens:object.sens,coords:object.position}),$(".selectMe").remove(),$(".sensArrows").remove()},ErrorView.prototype.manageLoginError=function(){$("#newName").css({color:"red","box-shadow":"0 0 5px red","-webkit-box-shadow":"0 0 5px red","-moz-box-shadow":"0 0 5px red","-o-box-shadow":"0 0 5px red"}),$("#newName").attr("placeholder","Requis, lettre uniquement. ' et - autorisés.")},HelperController.prototype.GetCurrentID=function(){return $(".userID").val()},HelperController.prototype.SetCurrentID=function(id){$(".userID").attr("value",id)},HelperController.prototype.GetCharacterDiv=function(id){return $(id?".character-"+id:".character-"+this.GetCurrentID())},HelperController.prototype.GetTuile=function(x,y){return $(x&&y?'.tuile[data-position="'+x+"-"+y+'"]':'.tuile[data-position="2-2"]')},HelperController.prototype.GetAction=function(action){return $(action?'.actions .action img[alt="'+action+'"]':".actions .action img")},MainView.prototype.setCaseEffect=function(ce){this.CaseEffect=ce},MainView.prototype.appendUserID=function(user){var that=this;that.Helper.SetCurrentID(user.id)},MainView.prototype.deleteCharacter=function(id,name,pseudo){$("ul.personnage li").each(function(){$(this).children("span").text()==name&&$(this).append('<div class="characterTaken characterTaken-'+id+'"><p>'+pseudo+"</p></div>")})},MainView.prototype.deleteUser=function(user){$(".characterTaken-"+user.id).remove()},MainView.prototype.refreshUsers=function(users){for(var u in users)users.hasOwnProperty(u)&&""!==users[u].character&&$("ul.personnage li").each(function(){var element=$(this);element.children("span").text()==users[u].character&&0===$(".characterTaken-"+users[u].id).length&&element.append('<div class="characterTaken characterTaken-'+users[u].id+'"><p>'+users[u].name+"</p></div>")})},MainView.prototype.showButton=function(){$(".btn").fadeIn(200,function(){$(".btn").css("display","block")})},MainView.prototype.deleteButton=function(){$(".btn").fadeOut(200)},MainView.prototype.redirectToGame=function(object){var that=this,userId=that.Helper.GetCurrentID();$(".readyToPlay").val(1),$(".readyToPlay").trigger("change"),setTimeout(function(){that.Helper.SetCurrentID(userId),that.showPlayers(object),that.showIdentity(object.users,userId),$(".coordsReady").val(1),$(".coordsReady").trigger("change")},500)},MainView.prototype.nextTurn=function(){$(".actions .action").fadeIn("slow"),$(".actions .action").children("p").remove(),$(".actions .action").each(function(){$(this).removeClass("ok").removeClass("actionOk-1").removeClass("actionOk-2"),$(this).css({"margin-top":"5px"})})},MainView.prototype.showPlayers=function(object){var that=this,cpt=0;for(var u in object.users)if(object.users.hasOwnProperty(u)){$(".gameboard").append(object.users[u].id!=$(".userID").val()?'<div class="character character-'+object.users[u].id+'">'+object.users[u].name+"</div>":'<div class="myCharacter character character-'+object.users[u].id+'">'+object.users[u].name+"</div>");var userDIV=that.Helper.GetCharacterDiv(object.users[u].id);cpt>=3?(userDIV.css("left",2*that.caseWidth+(cpt-3)*$(".character").outerWidth()+"px"),userDIV.css("top",2*that.caseHeight+$(".character").outerWidth()+"px")):(userDIV.css("left",2*that.caseWidth+cpt*$(".character").outerWidth()+"px"),userDIV.css("top",2*that.caseHeight+"px")),cpt++}},MainView.prototype.showIdentity=function(users,meID){for(var u in users)users.hasOwnProperty(u)&&users[u].id==meID&&($(".identity img").attr("src","/Images/identities/"+users[u].identity+".gif").attr("title",users[u].identity),$(".pseudo p").html(users[u].name))},MainView.prototype.animateAction=function(element,toggle){toggle?(element.animate({"margin-top":"20px"},300),element.addClass("ok").addClass("actionOk-"+$(".action.ok").length)):(element.animate({"margin-top":"5px"},300),element.removeClass("actionOk-"+element.attr("class").split(" ").last().split("-").last()).removeClass("ok"))},MainView.prototype.showButtonOk=function(){$(".btnOk").fadeIn("slow",function(){$(".btnOk").css("display","block")})},MainView.prototype.hideButtonOk=function(){$(".btnOk").fadeOut("slow")},MainView.prototype.disableActions=function(){$(".actions").append('<div class="loading"><p>En attente des autres joueurs...</p><img src="Images/loader.gif" alt="loader"></div>')},MainView.prototype.hideActions=function(){$(".loading img").remove(),$(".btnOk").fadeOut("slow"),$(".loading p").html("C'est parti !")},MainView.prototype.appendTurnOf=function(u,users,actionNumber){var that=this;if($(".tourDe p").html("Tour de "+u.name),u.id==$(".userID").val()){$(".loading").remove(),$(".actions .action").fadeOut("slow");var actionDIV;1==actionNumber?(actionDIV=that.Helper.GetAction(u.action1),actionDIV.parent().fadeIn(100).append("<p>"+actionDIV.parent().attr("data-first-sentence")+"</p>")):(actionDIV=that.Helper.GetAction(u.action2),actionDIV.parent().fadeIn(100).append("<p>"+actionDIV.parent().attr("data-first-sentence")+"</p>")),manageTurn(u,users)}},MainView.prototype.nextSentence=function(object){var that=this,actionDIV=that.Helper.GetAction(object.action);actionDIV.parent().children("p").html(actionDIV.parent().attr("data-second-sentence")),manageComplexAction(object)},MainView.prototype.deplacer=function(user){var that=this;that.Helper.GetCharacterDiv(user.id).animate({top:that.caseHeight*user.position.y+"px",left:that.caseWidth*user.position.x+"px"},500,function(){for(;that.someoneHere(user);)that.moveUser(user)});var tuile=that.Helper.GetTuile(user.position.x,user.position.y),imgs=tuile.children("img");imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),that.CaseEffect.manageCaseEffect(user,tuile.attr("data-action"))},MainView.prototype.pousser=function(user){var that=this;that.Helper.GetCharacterDiv(user.id).animate({top:that.caseHeight*user.position.y+"px",left:that.caseWidth*user.position.x+"px"},500);var tuile=that.Helper.GetTuile(user.position.x,user.position.y),imgs=tuile.children("img");imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),that.CaseEffect.manageCaseEffect(user,tuile.attr("data-action"))},MainView.prototype.regarder=function(user,coords){var that=this,position={x:coords.split("-")[0].parseInt(),y:coords.split("-")[1].parseInt()};if(user.id==that.Helper.GetCurrentID()){var imgs=that.Helper.GetTuile(position.x,position.y).children("img");imgs.first().hasClass("ng-hide")&&(imgs.first().removeClass("ng-hide"),imgs.first().fadeIn("slow"),imgs.last().fadeOut("slow"),setTimeout(function(){imgs.first().addClass("ng-hide"),imgs.first().fadeOut("slow"),imgs.last().fadeIn("slow")},3e3))}},MainView.prototype.controller=function(users,coords,sens){var that=this;"left"==sens||"right"==sens?$(".tuile").each(function(){var x=$(this).attr("data-position").split("-")[0].parseInt(),y=$(this).attr("data-position").split("-")[1].parseInt();y==coords.split("-")[1].parseInt()&&(0==x&&"left"===sens?x=4:4==x&&"right"===sens?x=0:"left"===sens?x-=1:x+=1,$(this).attr("data-position",x+"-"+y),$(this).addClass("moved"))}):("top"===sens||"bottom"===sens)&&$(".tuile").each(function(){var x=$(this).attr("data-position").split("-")[0].parseInt(),y=$(this).attr("data-position").split("-")[1].parseInt();x==coords.split("-")[0].parseInt()&&(0==y&&"top"===sens?y=4:4==y&&"bottom"===sens?y=0:"top"===sens?y-=1:y+=1,$(this).attr("data-position",x+"-"+y),$(this).addClass("moved"))}),$(".moved").each(function(){$(this).animate({top:$(this).attr("data-position").split("-")[1].parseInt()*that.caseHeight+"px",left:$(this).attr("data-position").split("-")[0].parseInt()*that.caseWidth+"px"},500)});for(var u in users)users.hasOwnProperty(u)&&that.Helper.GetCharacterDiv(users[u].id).animate({top:1*users[u].position.y*that.caseHeight,left:1*users[u].position.x*that.caseWidth},500);setTimeout(function(){for(var u in users)if(users.hasOwnProperty(u))for(;that.someoneHere(users[u]);)that.moveUser(users[u])},500),setTimeout(function(){$(".moved").removeClass("moved")},200)},MainView.prototype.someoneHere=function(user){var anybody=!1,$user=this.Helper.GetCharacterDiv(user.id);return $(".character").each(function(){$(this).css("top")!=$user.css("top")||$(this).css("left")!=$user.css("left")||$(this).hasClass("character-"+user.id)||(anybody=!0)}),anybody},MainView.prototype.moveUser=function(user){var userDIV=this.Helper.GetCharacterDiv(user.id);userDIV.css("left",userDIV.css("left").substr(0,userDIV.css("left").length-2).parseInt()+50+"px")};var LastCoords=[],OtherCoords=[];$(document).ready(function(){var Helper=new HelperController,View=new MainView(Helper),ErrView=new ErrorView(Helper),Client=new ClientController(View,Helper),CaseEffect=new CaseEffectController(Client);View.setCaseEffect(CaseEffect),Client.initialize(),$("body").on("click","#getMyName",function(){var patt=/[a-zA-Z\-\']+/;return patt.test($("#newName").val())?(Client.newUser($("#newName").val()),void $("#popin-grayback").fadeOut("slow")):(ErrView.manageLoginError(),!1)}),$("body").on("mouseover",".personnage li",function(){$this=$(this),$(".personnage li").each(function(){$this[0]!=$(this)[0]&&$(this).stop().animate({opacity:"0.6"},200)})}).on("mouseleave",".personnage li",function(){$(".personnage li").stop().animate({opacity:"1"},200)}),$("body").on("click","ul.personnage li, .characterTaken",function(e){e.stopPropagation(),$(this).hasClass("characterTaken")||($(".characterTaken-"+$(".userID").val()).remove(),Client.characterChoosen($(this).children("span").text(),$(".userID").val()))}),$("body").on("click",".btn",function(){Client.play()}),$("body").on("click",".action",function(){($(".action.ok").length<2||$(this).hasClass("ok"))&&(View.animateAction($(this),!$(this).hasClass("ok")),$(".action.ok").length>0?View.showButtonOk():View.hideButtonOk())}),$("body").on("click",".btnOk",function(){View.disableActions();var action2="";$(".actionOk-2").length>0&&(action2=$(".actionOk-2").children("img").attr("alt")),Client.validateAction($(".userID").val(),$(".actionOk-1").children("img").attr("alt"),action2)}),$("body").on("click",".tuile .selectMe, .character .characterSelectMe",function(){Client.emitAction($(this))}),$("body").on("click","span.direction",function(){var element=$(this),action="Contrôller",sens=element.removeClass("direction").attr("class"),position=element.parent().attr("data-position");return element.addClass("direction"),Client.emitComplexAction({element:element,action:action,sens:sens,position:position}),!1})});var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=Base64._utf8_encode(input);i<input.length;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4);return output},decode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)enc1=this._keyStr.indexOf(input.charAt(i++)),enc2=this._keyStr.indexOf(input.charAt(i++)),enc3=this._keyStr.indexOf(input.charAt(i++)),enc4=this._keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3));return output=Base64._utf8_decode(output)},_utf8_encode:function(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext},_utf8_decode:function(utftext){for(var string="",i=0,c=0,c2=0;i<utftext.length;)c=utftext.charCodeAt(i),128>c?(string+=String.fromCharCode(c),i++):c>191&&224>c?(c2=utftext.charCodeAt(i+1),string+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=utftext.charCodeAt(i+1),c3=utftext.charCodeAt(i+2),string+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return string}};!function(){"use strict";angular.module("Room25App").controller("CharacterCtrl",function($scope,$http,$location){$scope.characters=[],$scope.readyToPlay=-1,$http({method:"GET",url:"characters.json"}).success(function(data){$scope.characters=data}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)}),$scope.$watch("readyToPlay",function(newValue){"1"===newValue&&($scope.readyToPlay=newValue,$location.path("/game"))},!0)})}(),function(){"use strict";angular.module("Room25App").controller("GameCtrl",function($scope,$http){function getTuiles(data,last){var array=[];for(var t in data)data.hasOwnProperty(t)&&data[t].last===last&&array.push(data[t]);return array}$scope.tuiles=[],$scope.actions=[],$scope.coordsReady=-1,$http({method:"GET",url:"actions.json"}).success(function(data){$scope.actions=data}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)}),$scope.$watch("coordsReady",function(newValue){-1!==newValue&&$http({method:"GET",url:"tuiles.json"}).success(function(data){$scope.tuiles=$scope.mixTuiles(data,LastCoords,OtherCoords)}).error(function(data,status,headers,config){console.log(data),console.log(status),console.log(headers),console.log(config)})},!0),$scope.mixTuiles=function(data,last,other){var realTuile=getTuiles(data,!0);for(var t in realTuile)realTuile.hasOwnProperty(t)&&(realTuile[t].position.x=last[t].x,realTuile[t].position.y=last[t].y);var otherTuile=getTuiles(data,!1);for(var tu in otherTuile)otherTuile.hasOwnProperty(tu)&&(otherTuile[tu].position.x=other[tu].x,otherTuile[tu].position.y=other[tu].y);return realTuile.concat(otherTuile).concat(getTuiles(data,null))}})}(),function(){"use strict";var app=angular.module("Room25App",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"Views/home.html"}).when("/game",{templateUrl:"Views/game.html",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}),app.controller("MainCtrl",function(){})}();